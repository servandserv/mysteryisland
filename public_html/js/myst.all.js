var config = config || {};
config.components = [{
		src: "sun_blue",
		title: "Sun",
		desc: "The Sun gives away light and warmth, if you use the Sun and other artifacts you can get something that you need to get warmth and cook on the island.",
		visible: true,
		probability: 0.5
	},{
		src: "rain_blue",
		title: "Rain",
		desc: "(Atmospheric precipitations falling from clouds in the form of drops of water.) The Rain is one of the only water sourses on the island for tap water and to boil in the fire. And don't forget that the wind does not come every day.",
		visible: true,
		probability: 0.5
	},{
		src: "wind_blue",
		title: "Wind",
		desc: "Wind is the flow of gases on a large scale. On the surface of the Earth, wind consists of the bulk movement of air. The wind is very important for journeys on the sea. Especially for sailing boats and yahts. The wind will really help you for getting off the island. How to do this you will need to do it yourself. But don't forget that the right wind doesent always come.",
		visible: true,
		probability: 0.3
	},{
		src: "sand_blue",
		title: "Sand",
		desc: "Sand is a naturally occurring granular material composed of finely divided rock and mineral particles. The sand is a good building material think about how you could use it to bould the thing that you want. It's good that there is masses of sand on the island so you could build a ton of things to do with sand.",
		visible: true,
		probability: 1
	},{
		src: "rocks_blue",
		title: "Rocks",
		desc: "The rock is another good  building  material and it will help you as much as sand. But you can use rock differently like the anciant peaple to get food.",
		visible: true,
		probability: 1
	},{
		src: "palm_blue",
		title: "Coconut palm",
		desc: "The coconut palm is on of the only water sourses on the island. But it is not as good as the other ones because it won't make you un-thirsty like water but if you've got a rock with you you might as well get the juice to live.",
		visible: true,
		probability: 1
	},{
		src: "bamboo_blue",
		title: "Bamboo",
		desc: "The Bamboo is really helpful  across the entire island and you can do a lot of things with it. Bamboo is very light strong and grows quickly. Bamboo grows in discrete cylindrical sections which are hollow and walled at the top and bottom. For example: If you find yourself out of fresh water and not near a stream, you can get a drink from a friendly bamboo plant.",
		visible: true,
		probability: 1
	},{
		src: "insects_blue",
		title: "Insects",
		desc: "Man is born omnivorous, but few are willing to take this to heart and have a snack, such as bugs or crickets. Meanwhile, eating insects around the globe: they have more protein than chicken meat, full of iron, magnesium and other essential elements, finally, it's just delicious. Everything in the world there are 1,462 species of edible insects, and it is unlikely all of them you can try for a lifetime.",
		visible: true,
		probability: 0.6
	},{
		src: "birds_blue",
		title: "Birds",
		desc: "You won't be able to catch the Birds, But you can steal their eggs because eggs have a good amount of protein and it's pretty easy to do so you could survive easily on the protein and the water.",
		visible: true,
		probability: 0.4
	},{
		src: "fish_blue",
		title: "Fish",
		desc: "For Fish you need some kind of weapon because your not going to be able to catch them with bare hands. But they have a lot of protein in them so if you end up with a spear you could catch some Fish.",
		visible: true,
		probability: 0.4
	},{
		src: "fire_blue",
		title: "Fire",
		desc: "The fire could be very helpful for cooking your food, keeping your energy up, getting light and keeping away wild animals. Also giving signal and/or alarm from far away. The place for Fire pit desirable to select such a way that it is sheltered from the wind and rain some - some shelter, such as a rock. If available lighter or matches, then cherish. but they may not be. Think about what items you need to use to make fire? To the emerging light has turned to the fire, toss at first only small wood on larger proceed gradually, gently waved near the fire, helping it to swell. And be sure to remember that you must maintain a smoldering fire kindled, not to re-kindle it every time. Also, take care of firewood for the bonfire",
		visible: false,
		probability: 1
	},{
		src: "balloon_blue",
		title: "Air balloon",
		desc: "The Air Balloon is the thing that got you on the island. But it could be really helpful for clothes materials and other things. The Air Balloon gives you durable material that never gets wet and really tight ropes and maybe some iron for weapons.",
		visible: true,
		probability: 1
	},{
		src: "magnifier_blue",
		title: "Magnifier",
		desc: "Magnifier (Zoom) - Optical system consisting of a lens or multiple lenses, designed to increase and observing faint objects located at a finite distance. Used in many fields of human activity. The Magnifier could help you in a lot of situations like cooking food keeping away wild animals and a lot of other things.",
		visible: true,
		probability: 1
	},{
		src: "pocket_knife_blue",
		title: "Pocket knife",
		desc: "The pocket knife is a foldable knife with one or more blades that fit inside the handle that can still fit in a pocket. It is also known as a jackknife or jack-knife. A typical blade length is 5 to 15 centimetres (2 to 6 in). Pocket knives are versatile tools, and may be used for anything from opening an envelope, cutting twine, performing an emergency tracheotomy, slicing a piece of fruit or as a means of self-defense. The Pocket Knife could be helpful for getting water from plants.",
		visible: true,
		probability: 1
	},{
		src: "stone_axe_blue",
		title: "Tools",
		desc: "Tools would be amazingly helpful for cutting trees mining and getting down coconuts and eggs from trees and also for building your hut or raft. In the process of you being at the island you would have to make tools like, shovel, pickaxe and an axe to survive.",
		visible: false,
		probability: 1
	},{
		src: "spears_blue",
		title: "Weapons",
		desc: "You will need Weapons to survive against wild animals and to get food. The Weapons you will need are spear and a sling (weapon).  (The sling is a projectile weapon typically used to throw a blunt projectile such as a stone, clay or lead \"sling-bullet\". It is also known as the shepherd's sling. A sling has a small cradle or pouch in the middle of two lengths of cord. The sling stone is placed in the pouch. The middle finger or thumb is placed through a loop on the end of one cord, and a tab at the end of the other cord is placed between the thumb and forefinger.) And a spear (The spear is a pole weapon consisting of a shaft, usually of wood, with a pointed head. The head may be simply the sharpened end of the shaft itself, as is the case with bamboo spears, or it may be made of a more durable material fastened to the shaft, such as flint, obsidian, iron, steel or bronze. The most common design for hunting or combat spears since ancient times has incorporated a metal spearhead shaped like a triangle, lozenge or leaf. The heads of fishing spears usually feature barbs or serrated edges. Spears can be divided into two broad categories: those designed for thrusting in melee combat and those designed for throwing (usually referred to as javelins).",
		visible: false,
		probability: 1
	},{
		src: "hovel_blue",
		title: "Hovel",
		desc: "To build any shelter from the rain, wind, snow and sun, such as a Hut, Canopy or Hovel. Shelter gives us warm at night, shade in the afternoon, and the ability to hide our supplies of food, firewood and equipment. Type of cover will depend on your physical data material around enough. think about what items you'll be using this time. Have better shelter near a source of water and in the open. It is only necessary to prepare the site, build a fire to warm the ground carefully. Then move towards the fire, and just warmed the earth impose more branches, and the top cover of the available cloth.",
		visible: false,
		probability: 1
	},{
		src: "raft_blue",
		title: "Raft",
		desc: "A raft is any flat structure for support or transportation over water. It is the most basic of boat design, characterized by the absence of a hull. Although there are cross-over boat types that blur this definition, rafts are usually kept afloat by using any combination of buoyant materials such as wood, sealed barrels, or inflated air chambers (such as pontoons), and are typically not propelled by an engine.The Raft is the thing that is going to get you of the island and home.",
		visible: false,
		probability: 1
	}
];
config.actions = [{
		name: "Sleep",
		comment: "You could sleep on the GROUND to get a little bit of energy. But it's not a good idea to sleep in the mud.",
		components: [],
		energy: 60,
		food: -70,
		water: -100,
		points: 0,
		result: null
	},{
		name: "Sleep",
		comment: "Sleeping in warmth is much better. Making a fire before going to sleep could make you feel comfortable.",
		components: ["Fire"],
		energy: 100,
		food: -70,
		water: -100,
		points: 0,
		result: null
	},{
		name: "Sleep",
		comment: "But the best is sleeping in your own house with a fire. You could protect yourself from wild animals and keep yourself comfortable.",
		components: ["Fire","Hovel"],
		energy: 120,
		food: -70,
		water: -100,
		points: 0,
		result: null
	},{
		name: "Make water supplies",
		comment: "You could catch some water from the rain because it is the same as drinking water. \n\
		But it won't give you much water supplies.",
		components: ["Rain"],
		energy: -20,
		food: 0,
		water: 40,
		points: 5,
		result: null,
	},{
		name: "Make water supplies",
		comment: "BAMBOO has fresh drinking water inside it. So you could use your POCKET KNIFE to cut the middle \n\
		of the bamboo plant out and there would be water in it. If the water smells bad don't drink it. \n\
		If it smells ok go ahead.",
		components: ["Pocket knife","Bamboo"],
		energy: -25,
		food: 0,
		water: 60,
		points: 15,
		result: null
	},{
		name: "Make water supplies",
		comment: "If you want to get a lot of water from rain you could use your air balloon to gather up tons \n\
		of water. Dig a hole put the air balloon sheet in the hole and gather up a lot of water.",
		components: ["Rain","Air balloon"],
		energy: -50,
		food: 0,
		water: 100,
		points: 30,
		result: null
	},{
		name: "Make water & food supplies",
		comment: "Coconut palm are a source of water & food. But to use it you need to break the coconut whith a rock.",
		components: ["Rocks", "Coconut palm"],
		energy: -30,
		food: 20,
		water: 30,
		points: 10,
		result: null
	},{
		name: "Make food supplies",
		comment: "When there is nothing there to eat but you really need to then you can catch some insects cut them with you pocket knife and eat them. Insects are a good source of protein.",
		components: ["Insects","Pocket knife"],
		energy: -25,
		food: 50,
		water: 0,
		points: 20,
		result: null
	},{
		name: "Make food supplies",
		comment: "When there are around you could try and find their nest and take the eggs.",
		components: ["Birds"],
		energy: -40,
		food: 80,
		water: 0,
		points: 30,
		result: null
	},{
		name: "Make food supplies",
		comment: "Ftied eggs have a lot of protein in them so if you've made a fire and there are birds around \n\
		then you can get some fried eggs..",
		components: ["Birds","Fire"],
		energy: -45,
		food: 100,
		water: 0,
		points: 30,
		result: null
	},{
		name: "Make food supplies",
		comment: "If you got some weapons and you see fish you could make some sushi.",
		components: ["Fish","Weapons"],
		energy: -50,
		food: 120,
		water: 0,
		points: 40,
		result: null
	},{
		name: "Make food supplies",
		comment: "If you got some weapons and there are fish around you can get grilled or cooked fish.",
		components: ["Fish","Fire","Weapons"],
		energy: -60,
		food: 150,
		water: 0,
		points: 50,
		result: null
	},{
		name: "Make food supplies",
		comment: "If you got fire and weapons and there are birds around you can shoot the birds down and cook them and eat them.",
		components: ["Birds","Fire","Weapons"],
		energy: -60,
		food: 160,
		water: 0,
		points: 60,
		result: null
	},{
		name: "Make a fire",
		comment: "You could use the energy of the sun with your magnifier and make them go on to the bamboo so it could make a fire.",
		components: ["Magnifier","Sun","Bamboo"],
		energy: -30,
		food: 0,
		water: 0,
		points: 100,
		result: "Fire"
	},{
		name: "Make tools",
		comment: "To make something big or special you need tools. Stones will be good for the hammer. Bamboo are good for handels. The net of the air balloon will make good and strong ropes. All of this you will need to make with the pocket knife. ",
		components: ["Rocks","Bamboo","Pocket knife","Air balloon"],
		energy: -200,
		food: 0,
		water: 0,
		points: 100,
		result: "Tools"
	},{
		name: "Make weapons",
		comment: "For hunting and catching fish you need to make weapons. So you need to use your tools. Out of stone will be good for making the spear sharper. Bamboo are good for handels. The net of the air balloon will make good and strong ropes. All of this you will need to make with the pocket knife and other tools.",
		components: ["Tools","Rocks","Bamboo","Pocket knife","Air balloon"],
		energy: -200,
		food: 0,
		water: 0,
		points: 100,
		result: "Weapons"
	},{
		name: "Make a hovel",
		comment: "To make a good house you need to build the wall out of sand,rocks and bamboo. To cover the roof with the leaves of the palm. And make a fire place inside. for this you need to use your tools.   ",
		components: ["Fire","Sand","Rocks","Bamboo","Tools","Coconut palm"],
		energy: -300,
		food: 0,
		water: 0,
		points: 200,
		result: "Hovel"
	},{
		name: "Make a raft",
		comment: "For a raft you will need bamboo which you will make the actuall bottom and the mast. the air balloon to make the sail. the hovel to live while whe're in the journey.",
		components: ["Bamboo","Tools","Air balloon","Hovel"],
		energy: -300,
		food: 0,
		water: 0,
		points: 200,
		result: "Raft"
	},{
		name: "Go away",
		comment: "Now you ready to go home. You should have enough energy, food and water to make a long trip, and wind will help you.",
		components: ["Raft","Wind"],
		energy: -300,
		food: -200,
		water: -200,
		points: 300,
		result: null
	}
];
config.results = {
	energy: 200,
	food: 200,
	water: 200,
	points: 0,
	days: 0,
	rating: 0,
	counter: 0
};
config.energyRatio = 3;
config.dayEnergy = 100;;(function(w,conf){
	
	w.myst = w.myst || {
		Model: {},
		Collection: {},
		View: {},
		Router: {}
	};
	
	myst.Model.Results = Backbone.Model.extend({
		reset: function(){
			init();
		},
		doAction: function( action ) {
			var alive = true;
			var energy = this.get("energy") + action.get("energy");
			var water = this.get("water") + action.get("water");
			var food = this.get("food") + action.get("food");
			// if water less then 0 we use energy to restore supply with rate 1:2
			if(water < 0) {
				energy += water * conf.energyRatio;
				water = 0;
				
			}
			//if food less then 0 we use energy to restore supply with rate 1:2
			if(food < 0) {
				energy += food * conf.energyRatio;
				food = 0;
			}
			while( energy < 0 ) {
				if(food <= 0 && water <= 0) break;
				if( food > 0 ) {
					food -= conf.energyRatio / 2;
					food = _.max([food,0]);
				}
				if( water > 0 ) {
					water -= conf.energyRatio / 2;
					water = _.max([water,0]);
				}
				energy++;
			}
			// if energy still les then 0 you are died baby 
			if( energy < 0 ) alive = false;
			
			var points = this.get("points") + action.get("points");
			var days = this.get("days"), 
				counter = this.get("counter") - action.get("energy");
			
			if(action.get("name") === "Sleep") {
				days++;
				counter = 0;
			} else {
				days += Math.floor( counter / conf.dayEnergy );
				counter = counter - Math.floor( counter / conf.dayEnergy ) * conf.dayEnergy;
			}
			this.set( {
				energy: Math.round(energy),
				food: Math.round(food),
				water: Math.round(water),
				points: points,
				days: days,
				rating: days ? Math.round( points / days ) : 0,
				counter: counter
			});
			// activate new component
			if(action.get("result")) {
				components.activate(action.get("result"));
			}
			selected.reset();
			if( !alive ) router.navigate( "end", { trigger:true } );
			if( action.get("name") === "Go away" ) router.navigate( "victory", { trigger:true } );
		}
		
	});
	
	myst.Model.Action = Backbone.Model.extend({
		
	});
	
	myst.Collection.ReadyActions = Backbone.Collection.extend({
		
		model: myst.Model.Action
		
	});
	
	myst.Model.Component = Backbone.Model.extend({
		defaults: function() {
			return {
				src: null,
				title: null,
				desc: null,
				visible: false
			};
		}
    });
    
    myst.Collection.ComponentList = Backbone.Collection.extend({
		
		model: myst.Model.Component,
		//localStorage: new Backbone.LocalStorage("myst-components")
		activate: function(title) {
			var cs = this.where({title: title});
			for(var i = 0; i < cs.length; i++) {
				cs[i].set("visible",true);
			}
			this.add(cs,{merge:true});
		}
		
    });
	
    myst.Collection.SelectedComponents = Backbone.Collection.extend({
		
		model: myst.Model.Component,
		
    });
    //Views
	myst.View.Intro = Backbone.View.extend({
	
		tagName: "div",
		template:_.template($('#tpl-intro').html()),
		events:{
            "click #get-started": "getStarted",
        },
		render: function( eventName ) {
			//this.template();
			$(this.el).html(this.template());
			return this;
		},
		getStarted: function() {
			init();
		}
    });
	
	myst.View.End = Backbone.View.extend({
		tagName: "div",
		className: "died-layout",
		template: _.template($('#tpl-end').html()),
		events:{
            "click #try-again": "restart"
        },
		render: function( eventName ) {
			$(this.el).html(this.template(this.model.toJSON()));
			return this;
		},
		restart: function() {
			init();
		}
	});
	
	myst.View.Victory = Backbone.View.extend({
		tagName: "div",
		className: "victory-layout",
		template: _.template($('#tpl-victory').html()),
		events:{
            "click #one-more": "restart"
        },
		render: function( eventName ) {
			$(this.el).html(this.template(this.model.toJSON()));
			return this;
		},
		restart: function() {
			init();
		}
	});
	
	myst.View.Results = Backbone.View.extend({
		
		tagName: "table",
		className: "results pure-table pure-table-striped",
		
		template: _.template($('#tpl-results').html()),
		
		initialize: function() {
			this.listenTo(this.model, 'change', this.render);
		},
		
		render:function (eventName) {
			$(this.el).html(this.template(this.model.toJSON()));
			return this;
		}
	});
	
	myst.View.ActiveComponents = Backbone.View.extend({
		
		tagName:"ul",
		className: "active-components",
		
		initialize: function() {
			this.listenTo( selected, 'reset', this.render );
			this.listenTo( components, 'add', this.render );
		},
		render: function ( eventName ) {
			$(this.el).html("");
			var visible = this.model.where({visible:true});
			_.each(visible,function(component){
				if( Math.random() < component.get("probability")) {
					var view = new myst.View.ActiveComponent( { model: component } );
					this.$el.append(view.render().el);
				}
			},this);
            return this;
		}
	});
	
	myst.View.ActiveComponent = Backbone.View.extend({
		tagName: "li",
		template:_.template($('#tpl-active-component').html()),
		render: function ( eventName ) {
			$(this.el).html(this.template(this.model.toJSON()));
			return this;
		},
		events:{
            "click .active-component": "selectComponent",
        },
        selectComponent: function() {
			if( $(this.el).hasClass("checked-component") ){
				$(this.el).removeClass("checked-component");
				selected.remove(this.model);
			} else {
				selected.add(this.model);
				$(this.el).addClass("checked-component");
			}
        }
 
    });
	
	myst.View.ReadyActions = Backbone.View.extend({
		tagName:"ul",
		className: "ready-actions",
		initialize: function() {
			this.listenTo( selected, 'all', this.render );
		},
		render: function ( eventName ) {
			$(this.el).html("");
			var titles = [];
			for( var i = 0; i < selected.models.length; i++ ) {
				titles.push(selected.models[i].get("title"));
			}
			//console.info(titles);
			this.model.each(function(action) {
				var needs = action.get("components");
				var visible = false;
				if(needs.length === titles.length && needs.length === 0 ) visible = true;
				else if(needs.length === titles.length && _.difference(needs,titles).length === 0) {
					visible = true;
				}
				if( visible ) {
					var view = new myst.View.ReadyAction( { model: action } );
					this.$el.append(view.render().el);
				}
			}, this);
            return this;
		}
	});
	
	myst.View.ReadyAction = Backbone.View.extend({
		tagName: "li",
		template:_.template($('#tpl-ready-action').html()),
		events:{
            "click .pure-button": "doit"
        },
		render: function ( eventName ) {
			$(this.el).html(this.template(this.model.toJSON()));
			return this;
		},
		doit: function() {
			results.doAction( this.model );
		}
	});

    // Router
    myst.Router = Backbone.Router.extend({
		
		routes:{
			"": "intro",
			"game": "game",
			"end": "end",
			"help": "help",
			"victory": "victory",
			"print": "print"
		},

		intro:  function() {
			var view = new myst.View.Intro();
			$('.pure-menu-selected').removeClass('pure-menu-selected');
			$('#menu-home').addClass('pure-menu-selected');
			$('#view').html( view.render().el );
		},
		
		game: function() {
			$('#view').html( _.template($('#tpl-game').html()));
			$('.pure-menu-selected').removeClass('pure-menu-selected');
			$('#menu-home').addClass('pure-menu-selected');
			
			var view = new myst.View.Results( { model: results } );
			$('#results-layout').html( view.render().el );
			
			var view = new myst.View.ActiveComponents( { model: components } );
			$('#active-components-layout').html( view.render().el );
			
			var view = new myst.View.ReadyActions( { model: actions } );
			$('#ready-actions-layout').html( view.render().el );
		},
		
		help:function() {
			$('.pure-menu-selected').removeClass('pure-menu-selected');
			$('#menu-help').addClass('pure-menu-selected');
			var template = _.template($('#tpl-help').html());
			$('#view').html(template({ components: conf.components }));
		},
		
		end: function() {
			var view = new myst.View.End({model:results});
			$('#view').html( view.render().el );
		},
		
		victory: function() {
			var view = new myst.View.Victory({model:results});
			$('#view').html( view.render().el );
		},
		
		print: function() {
			var template = _.template($('#tpl-print').html());
			$('#view').html(template({ conf: conf }));
		}
    });
	
	var components, actions, selected, results;
	
	var init = function(){
		components = new myst.Collection.ComponentList( conf.components );
		actions = new myst.Collection.ReadyActions( conf.actions );
		selected = new myst.Collection.SelectedComponents();
		results = new myst.Model.Results( conf.results );
	}
	
	init();
	var router = new myst.Router();
	Backbone.history.start();
	
}(window, config));



